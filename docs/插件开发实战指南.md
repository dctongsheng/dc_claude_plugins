# Claude Code 插件开发实战指南

本文档记录了从零开始创建 Claude Code 插件市场的完整过程，包括遇到的问题、解决方案和最佳实践。

## 目录

- [项目概述](#项目概述)
- [准备工作](#准备工作)
- [创建插件仓库](#创建插件仓库)
- [开发第一个插件：SSH 管理器](#开发第一个插件ssh-管理器)
- [遇到的问题与解决方案](#遇到的问题与解决方案)
- [官方文档参考](#官方文档参考)
- [最佳实践](#最佳实践)
- [附录](#附录)

---

## 项目概述

### 目标

创建一个个人插件集合市场，用于管理和分发自定义 Claude Code 插件。

### 技术栈

- **Claude Code**: Anthropic 的 AI 编程助手
- **Plugin API**: Claude Code 插件系统
- **JSONL**: 数据存储格式
- **Bash + jq**: 数据处理

### 最终成果

- ✅ 插件市场配置正确
- ✅ 示例插件（example-plugin）
- ✅ SSH 管理器插件（ssh-manager）
- ✅ Git 版本控制
- ✅ 完整文档

---

## 准备工作

### 环境信息

```bash
# 容器信息
容器名: bws-dind-dev-26
SSH 端口: 2222
项目端口范围: 20300-20400

# 工作目录
/workspace/xm/claude-plugins
```

### 创建项目目录

```bash
# 创建项目目录
mkdir -p /workspace/xm/claude-plugins

# 初始化 Git 仓库
cd /workspace/xm/claude-plugins
git init

# 配置 Git 用户信息
git config user.name "Claude Plugins Developer"
git config user.email "developer@claude-plugins.local"
```

### 安装依赖

```bash
# 安装 jq（JSON 处理工具）
apt-get update && apt-get install -y jq

# 或在 Alpine 上
apk add jq
```

---

## 创建插件仓库

### 1. 目录结构设计

根据 Claude Code 官方规范，插件市场需要特定的目录结构：

```
claude-plugins/
├── .claude-plugin/
│   └── marketplace.json      # 市场配置文件（必需）
├── plugins/                  # 插件目录
│   ├── example-plugin/       # 示例插件
│   │   ├── plugin.json       # 插件清单
│   │   ├── README.md         # 插件文档
│   │   ├── skills/           # 技能目录
│   │   ├── commands/         # 命令目录
│   │   └── hooks/            # 钩子目录
│   └── ssh-manager/          # SSH 管理器插件
├── scripts/                  # 工具脚本
├── docs/                     # 文档
├── README.md                 # 项目说明
└── DEVELOPMENT.md            # 开发指南
```

### 2. 创建核心文件

#### 项目 README.md

```markdown
# Personal Plugins Collection

个人 Claude Code 插件集合。

## 安装

```bash
# 从本地市场安装
/plugin
# 输入: /workspace/xm/claude-plugins
```

## 可用插件

- **ssh-manager**: SSH 连接管理器
- **example-plugin**: 示例插件
```

#### 开发指南 DEVELOPMENT.md

包含插件开发的完整指南，包括：
- 快速开始
- 插件结构
- 添加功能
- 测试方法
- 高级功能
- 最佳实践

### 3. 创建市场配置

#### 市场配置文件

**位置**: `.claude-plugin/marketplace.json`

```json
{
  "$schema": "https://anthropic.com/claude-code/marketplace.schema.json",
  "name": "personal-plugins",
  "version": "1.0.0",
  "description": "Personal collection of development and utility plugins",
  "owner": {
    "name": "Your Name",
    "email": "your.email@example.com"
  },
  "plugins": [
    {
      "name": "ssh-manager",
      "description": "Manage SSH connections with CRUD operations",
      "source": "./plugins/ssh-manager",
      "category": "utilities"
    },
    {
      "name": "example-plugin",
      "description": "Example plugin demonstrating basic features",
      "source": "./plugins/example-plugin",
      "category": "examples"
    }
  ]
}
```

**重要说明**:
- 市场名称不能包含 "claude"、"anthropic"、"official" 等保留词
- `source` 路径必须使用相对路径 `./`
- 配置文件必须在 `.claude-plugin/` 目录下

---

## 开发第一个插件：SSH 管理器

### 需求分析

**功能需求**:
- 查看 SSH 连接列表
- 添加新连接
- 编辑现有连接
- 删除连接

**技术要求**:
- 使用 Commands 方式实现
- 数据以 JSONL 格式存储
- 支持完整的 CRUD 操作

### 插件结构

```
ssh-manager/
├── plugin.json              # 插件清单
├── README.md                # 插件文档
├── USAGE_EXAMPLES.md        # 使用示例
├── commands/                # 命令定义
│   ├── ssh-list.md
│   ├── ssh-add.md
│   ├── ssh-edit.md
│   └── ssh-delete.md
├── scripts/                 # 脚本工具
│   └── ssh-manager-lib.sh   # 核心函数库
├── data/                    # 数据目录
│   └── connections.jsonl    # 数据存储
└── hooks/
    └── hooks.json           # 钩子配置
```

### 1. 创建 plugin.json

根据官方文档，`plugin.json` 的有效字段：

```json
{
  "name": "ssh-manager",
  "version": "1.0.0",
  "description": "Manage SSH connection information with CRUD operations",
  "author": {
    "name": "Claude Plugins Developer",
    "email": "developer@claude-plugins.local"
  },
  "license": "MIT"
}
```

**有效字段说明**:
- `name` (必需): 插件名称，必须使用 kebab-case
- `version` (可选): 语义化版本号 (X.Y.Z)
- `description` (可选): 插件描述
- `author` (可选): 作者信息，可以是对象或字符串
- `license` (可选): 许可证
- `homepage`, `repository`, `keywords` (可选): 元数据
- `commands`, `agents`, `hooks`, `mcpServers` (可选): 功能配置

**注意**: 不要添加自定义字段（如 `claude`），会导致验证失败。

### 2. 创建 Commands

Commands 是可执行的 shell 命令，通过 Markdown 文件定义。

#### ssh-list.md - 列出连接

```markdown
# SSH List Command

List all SSH connections.

## Usage

```bash
/ssh-list
```

## Description

Displays all saved SSH connections in a formatted table...
```

#### ssh-add.md - 添加连接

```markdown
# SSH Add Command

Add a new SSH connection.

## Usage

```bash
/ssh-add <name> <host> <user> [port] [identity_file] [description]
```

## Arguments

- `name` - Connection name (required, must be unique)
- `host` - Host address or IP (required)
...
```

#### ssh-edit.md - 编辑连接

```markdown
# SSH Edit Command

Edit an existing SSH connection.

## Usage

```bash
/ssh-edit <index> <field>=<value> [<field>=<value> ...]
```
```

#### ssh-delete.md - 删除连接

```markdown
# SSH Delete Command

Delete an SSH connection.

## Usage

```bash
/ssh-delete <index>
```
```

### 3. 实现核心逻辑

创建 `scripts/ssh-manager-lib.sh`：

```bash
#!/bin/bash
# SSH Manager Library - Handle JSONL operations

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DATA_FILE="$SCRIPT_DIR/../data/connections.jsonl"

# 生成唯一 ID
generate_id() {
    date +%s%N
}

# 列出所有连接
list_connections() {
    ensure_data_file

    if [ ! -s "$DATA_FILE" ]; then
        echo "No SSH connections found."
        return 0
    fi

    echo "SSH Connections:"
    echo ""
    printf "%-5s %-20s %-30s %-15s %-10s\n" "ID" "Name" "Host" "User" "Port"
    echo "------------------------------------------------------------------------------------------------"

    local index=1
    while IFS= read -r line; do
        if [ -n "$line" ]; then
            local name=$(echo "$line" | jq -r '.name')
            local host=$(echo "$line" | jq -r '.host')
            local user=$(echo "$line" | jq -r '.user')
            local port=$(echo "$line" | jq -r '.port // 22')

            printf "%-5s %-20s %-30s %-15s %-10s\n" "$index" "$name" "$host" "$user" "$port"
            ((index++))
        fi
    done < "$DATA_FILE"
}

# 添加连接
add_connection() {
    local name="$1"
    local host="$2"
    local user="$3"
    local port="${4:-22}"
    local identity_file="$5"
    local description="$6"

    ensure_data_file

    # 检查名称是否已存在
    if grep -q "\"name\":\"$name\"" "$DATA_FILE" 2>/dev/null; then
        echo "Error: Connection '$name' already exists."
        return 1
    fi

    local id=$(generate_id)
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    local json=$(cat <<EOF
{
  "id": "$id",
  "name": "$name",
  "host": "$host",
  "user": "$user",
  "port": $port,
  "identity_file": $([ -n "$identity_file" ] && echo "\"$identity_file\"" || echo "null"),
  "description": $([ -n "$description" ] && echo "\"$description\"" || echo "null"),
  "created_at": "$timestamp",
  "updated_at": "$timestamp"
}
EOF
)

    echo "$json" >> "$DATA_FILE"
    echo "✓ SSH connection '$name' added successfully."
}

# 删除连接
delete_connection() {
    local index=$1
    local line_num=0
    local temp_file=$(mktemp)
    local deleted_name=""

    while IFS= read -r line; do
        if [ -n "$line" ]; then
            ((line_num++))
            if [ "$line_num" -ne "$index" ]; then
                echo "$line" >> "$temp_file"
            else
                deleted_name=$(echo "$line" | jq -r '.name')
            fi
        fi
    done < "$DATA_FILE"

    mv "$temp_file" "$DATA_FILE"
    echo "✓ SSH connection '$deleted_name' deleted successfully."
}

# 编辑连接
edit_connection() {
    local index=$1
    shift
    local updates="$@"

    # 实现编辑逻辑...
}

# 导出函数
export -f list_connections
export -f add_connection
export -f delete_connection
export -f edit_connection
```

### 4. 数据存储格式

使用 JSONL (JSON Lines) 格式，每行一个 JSON 对象：

```json
{"id":"1736419200000000000","name":"localhost","host":"127.0.0.1","user":"root","port":2222,"identity_file":null,"description":null,"created_at":"2026-01-09T12:00:00Z","updated_at":"2026-01-09T12:00:00Z"}
{"id":"1736419200000000001","name":"production","host":"prod.example.com","user":"admin","port":22,"identity_file":"/home/user/.ssh/id_rsa","description":"Production server","created_at":"2026-01-09T12:05:00Z","updated_at":"2026-01-09T12:05:00Z"}
```

---

## 遇到的问题与解决方案

### 问题 1: 市场配置文件路径错误

**错误信息**:
```
Marketplace file not found at /workspace/xm/claude-plugins/.claude-plugin/marketplace.json
```

**原因**:
市场配置文件放在了根目录，而不是 `.claude-plugin/` 目录下。

**解决方案**:
```bash
# 创建正确的目录结构
mkdir -p /workspace/xm/claude-plugins/.claude-plugin

# 移动配置文件
mv marketplace.json .claude-plugin/marketplace.json
```

**教训**:
Claude Code 要求市场配置必须在 `<marketplace-path>/.claude-plugin/marketplace.json`

### 问题 2: 市场名称包含保留词

**错误信息**:
```
Invalid schema: name: Marketplace name cannot impersonate official Anthropic/Claude marketplaces.
Names containing "official", "anthropic", or "claude" in official-sounding combinations are reserved.
```

**原因**:
市场名称使用了 "claude-plugins"，包含保留词 "claude"。

**解决方案**:
```json
{
  "name": "personal-plugins",  // 改为其他名称
  "description": "Personal collection of development and utility plugins"
}
```

**有效命名示例**:
- ✅ `personal-plugins`
- ✅ `my-dev-tools`
- ✅ `workspace-plugins`
- ✅ `custom-extensions`
- ❌ `claude-plugins`
- ❌ `anthropic-tools`
- ❌ `official-plugins`

### 问题 3: plugin.json 包含无效字段

**错误信息**:
```
Error: Failed to install: Plugin has an invalid manifest file.
Validation errors: : Unrecognized key(s) in object: 'claude'
```

**原因**:
在 `plugin.json` 中添加了官方规范不存在的字段：
```json
{
  "claude": {
    "minVersion": "1.0.0"
  }
}
```

**解决方案**:
删除无效字段，只保留官方支持的字段：
```json
{
  "name": "ssh-manager",
  "version": "1.0.0",
  "description": "Manage SSH connections",
  "author": {
    "name": "Developer",
    "email": "developer@example.com"
  },
  "license": "MIT"
}
```

**有效字段列表**:
- `name` (必需)
- `version` (可选)
- `description` (可选)
- `author` (可选)
- `license` (可选)
- `homepage` (可选)
- `repository` (可选)
- `keywords` (可选)
- `commands` (可选)
- `agents` (可选)
- `hooks` (可选)
- `mcpServers` (可选)

### 问题 4: 插件名称格式错误

**验证规则**:
插件名称必须使用 kebab-case 格式：
- 必须以字母开头
- 只能包含小写字母、数字和连字符
- 不能有空格或特殊字符

**正则表达式**:
```javascript
/^[a-z][a-z0-9]*(-[a-z0-9]+)*$/
```

**有效示例**:
- ✅ `my-plugin`
- ✅ `ssh-manager`
- ✅ `code-quality`
- ❌ `My Plugin`
- ❌ `my_plugin`
- ❌ `my plugin`

---

## 官方文档参考

### 1. 插件结构

根据官方文档，完整的插件结构：

```
plugin-name/
├── .claude-plugin/
│   └── plugin.json           # 插件清单（必需）
├── skills/                   # 技能目录（可选）
│   └── *.md                 # 技能文件
├── commands/                 # 命令目录（可选）
│   └── *.md                 # 命令文件
├── hooks/                    # 钩子目录（可选）
│   └── hooks.json           # 钩子配置
├── agents/                   # 代理目录（可选）
└── .mcp.json                # MCP 配置（可选）
```

### 2. plugin.json 完整配置

```json
{
  "name": "my-plugin",
  "version": "1.0.0",
  "description": "Brief description",
  "author": {
    "name": "Author Name",
    "email": "author@example.com",
    "url": "https://example.com"
  },
  "homepage": "https://docs.example.com",
  "repository": {
    "type": "git",
    "url": "https://github.com/user/my-plugin.git"
  },
  "license": "MIT",
  "keywords": ["keyword1", "keyword2"],
  "commands": ["./commands"],
  "agents": "./agents",
  "hooks": "./hooks.json",
  "mcpServers": "./.mcp.json"
}
```

### 3. 市场配置

```json
{
  "$schema": "https://anthropic.com/claude-code/marketplace.schema.json",
  "name": "marketplace-name",
  "version": "1.0.0",
  "description": "Marketplace description",
  "owner": {
    "name": "Owner Name",
    "email": "owner@example.com"
  },
  "plugins": [
    {
      "name": "plugin-name",
      "description": "Plugin description",
      "source": "./plugins/plugin-name",
      "category": "category-name"
    }
  ]
}
```

### 4. Hooks 配置

```json
{
  "description": "Plugin hooks",
  "hooks": {
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "prompt",
            "prompt": "Welcome message"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Write",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/validate.sh"
          }
        ]
      }
    ]
  }
}
```

**可用 Hook 事件**:
- `SessionStart` - 会话开始
- `SessionEnd` - 会话结束
- `PreToolUse` - 工具使用前
- `PostToolUse` - 工具使用后

**Hook 类型**:
- `prompt` - 修改 AI 行为
- `command` - 执行 shell 命令

### 5. MCP 服务器配置

```json
{
  "mcpServers": {
    "server-name": {
      "command": "node",
      "args": ["${CLAUDE_PLUGIN_ROOT}/servers/server.js"],
      "env": {
        "API_KEY": "${API_KEY}"
      }
    }
  }
}
```

---

## 最佳实践

### 1. 命名规范

**插件名称**:
- 使用 kebab-case
- 描述性但简洁
- 避免保留词

**Commands**:
- 使用前缀避免冲突
- 动词开头
- 示例：`/ssh-add`, `/ssh-list`

**Skills**:
- 清晰的名称
- 描述性提示词

### 2. 文档

**每个插件应包含**:
- `README.md` - 功能说明和基本用法
- `USAGE_EXAMPLES.md` - 详细使用示例
- Command 文档 - 使用方法和参数说明

### 3. 数据管理

**推荐格式**:
- JSONL: 每行一个 JSON 对象
- 易于追加和删除
- 适合大量记录

**数据位置**:
```
plugin-name/
└── data/
    └── data.jsonl
```

### 4. 错误处理

**脚本最佳实践**:
```bash
#!/bin/bash
set -e  # 遇到错误立即退出

# 输入验证
if [ -z "$1" ]; then
    echo "Error: Missing required argument"
    return 1
fi

# 数据验证
ensure_data_file() {
    if [ ! -f "$DATA_FILE" ]; then
        touch "$DATA_FILE"
    fi
}
```

### 5. 版本控制

**Git 提交信息**:
```
feat: Add new feature
fix: Fix bug
docs: Update documentation
refactor: Refactor code
```

**.gitignore**:
```
# macOS
.DS_Store

# IDEs
.idea/
.vscode/

# Logs
*.log

# Data (可选)
data/*.jsonl
```

### 6. 测试

**本地测试流程**:
```bash
# 1. 加载插件
cc --plugin-dir /path/to/plugin

# 2. 测试 commands
/ssh-list
/ssh-add test 127.0.0.1 root

# 3. 验证数据
cat data/connections.jsonl

# 4. 调试模式
cc --debug --plugin-dir /path/to/plugin
```

---

## 附录

### A. Git 提交历史

```bash
git log --oneline
1b5fc92 Initial commit: Claude Code plugins repository
091a637 Add ssh-manager plugin
2abad78 Fix: Move marketplace.json to correct location
ec44131 Fix: Rename marketplace to avoid reserved keywords
2108e97 Fix: Remove invalid 'claude' field from plugin.json
```

### B. 目录结构总览

```
/workspace/xm/claude-plugins/
├── .claude-plugin/
│   └── marketplace.json          # 市场配置
├── .git/
├── plugins/
│   ├── example-plugin/
│   │   ├── commands/
│   │   │   └── hello.md
│   │   ├── hooks/
│   │   │   └── hooks.json
│   │   ├── skills/
│   │   │   └── greet.md
│   │   ├── plugin.json
│   │   └── README.md
│   ├── ssh-manager/
│   │   ├── commands/
│   │   │   ├── ssh-add.md
│   │   │   ├── ssh-delete.md
│   │   │   ├── ssh-edit.md
│   │   │   └── ssh-list.md
│   │   ├── data/
│   │   │   └── connections.jsonl
│   │   ├── hooks/
│   │   │   └── hooks.json
│   │   ├── scripts/
│   │   │   └── ssh-manager-lib.sh
│   │   ├── plugin.json
│   │   ├── README.md
│   │   └── USAGE_EXAMPLES.md
│   └── templates/
│       ├── plugin.json
│       └── README.md
├── scripts/
│   └── create-plugin.sh
├── DEVELOPMENT.md
├── README.md
└── port.md
```

### C. 快速命令参考

```bash
# 安装市场
/plugin
# 输入: /workspace/xm/claude-plugins

# 创建新插件
/workspace/xm/claude-plugins/scripts/create-plugin.sh my-plugin

# 测试插件
cc --plugin-dir /workspace/xm/claude-plugins/plugins/my-plugin

# 查看已安装插件
/plugin

# 卸载插件
/plugin uninstall plugin-name
```

### D. 资源链接

- [Claude Code 官方文档](https://github.com/anthropics/claude-code)
- [插件开发指南](https://github.com/anthropics/claude-code/tree/main/plugins/plugin-dev)
- [MCP 协议规范](https://modelcontextprotocol.io/)

### E. 常见问题 FAQ

**Q: 如何调试插件？**
```bash
cc --debug --plugin-dir /path/to/plugin
```

**Q: 插件数据存储在哪里？**
```bash
# 用户级插件
~/.claude/plugins/plugin-name/

# 本地插件（开发中）
/path/to/plugin/data/
```

**Q: 如何分享插件？**
1. 推送到 GitHub
2. 创建 marketplace.json
3. 用户通过 `/plugin` 安装

**Q: Commands 和 Skills 有什么区别？**
- **Commands**: 执行具体的 shell 命令，确定性强
- **Skills**: 自然语言提示，更灵活，引导 AI 行为

**Q: 如何处理敏感数据？**
- 不要在插件中硬编码密钥
- 使用环境变量：`${API_KEY}`
- 在 `.gitignore` 中排除数据文件

---

## 总结

通过本次实践，我们成功创建了：

1. ✅ **插件市场**: 符合 Claude Code 规范的市场配置
2. ✅ **SSH 管理器**: 功能完整的 CRUD 插件
3. ✅ **开发工具**: 插件创建脚本和模板
4. ✅ **完整文档**: 使用说明和开发指南

### 关键收获

1. **遵循规范**: 严格遵守官方规范，避免使用保留词和无效字段
2. **目录结构**: 市场配置必须在 `.claude-plugin/` 目录下
3. **命名规范**: 使用 kebab-case，避免特殊字符
4. **文档优先**: 完善的文档让插件更易用
5. **版本控制**: 使用 Git 管理代码，记录变更历史

### 下一步

1. 添加更多实用插件
2. 实现插件间的协作
3. 集成 MCP 服务器
4. 推送到 GitHub 公开分享
5. 持续优化和迭代

---

**文档版本**: 1.0.0
**最后更新**: 2026-01-09
**作者**: Claude Plugins Developer
